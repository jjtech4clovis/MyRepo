---

description: "Install vault root cA on server using SSM Automation"
schemaVersion: "0.3"
assumeRole: "${assumeRole}"
parameters:
  pathToScripts:
    default: "${pathToScripts}"
    description: "Path in S3 bucket where Vault CA scripts are placed"
    type: "String"
  configBucket:
    default: "${configBucket}"
    description: "S3 bucket where Patch artifacts are placed"
    type: "String" 
  environment:
    default: "${environment}"
    description: "Environment and server where vault root ca will be installed"
    type: "String"
mainSteps:
- name: "targetInstanceIds"
  action: aws:executeAwsApi
  onFailure: "Abort"
  inputs:
    Service: ec2
    Api: DescribeInstances
    Filters:  
    - Name: "tag:component"
      Values: ["${component_tag_appname}"]
    - Name: "tag:environment"
      Values: ["${environment}"]
    - Name: "tag:region"
      Values: ["${region}"]
    - Name: "instance-state-name"
      Values: [ "running" ]
  outputs:
  - Name: InstanceIds
    Selector: "$.Reservations..Instances..InstanceId"
    Type: "StringList"
      
################################### Begin Step:1 ##############################

- name: "createScriptsDirectory"
  action: "aws:runCommand"
  onFailure: "Abort"
  inputs:
    DocumentName: "AWS-RunPowerShellScript"
    InstanceIds:
      - "{{targetInstanceIds.InstanceIds}}"
    Parameters:
      commands:
        - |            
            md C:/vaultCA

- name: "downloadSimCertScriptsFromS3"
  action: "aws:runCommand"
  onFailure: "Abort"
  inputs:
    DocumentName: "AWS-RunPowerShellScript"
    InstanceIds:
      - "{{targetInstanceIds.InstanceIds}}"
    Parameters:
      commands:
        - |            
            aws s3 cp s3://{{configBucket}}/{{pathToScripts}} C:/vaultCA/sim_cert.ps1

- name: "RunSimCertPS1Script"
  action: "aws:runCommand"
  onFailure: "Abort"
  inputs:
    DocumentName: "AWS-RunPowerShellScript"
    InstanceIds:
      - "{{targetInstanceIds.InstanceIds}}"
    Parameters:
      commands:
        - |            
            C:\vaultCA\sim_cert.ps1
